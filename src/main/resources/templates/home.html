<html>
<head>
    <title>Monkey notes</title>

</head>
<body>

<div>
    <a href="/">Monkey Notes</a>
    <a href="/preferences">Preferences</a>
    <a href="/processing">Processes</a>
</div>

<div>
    <span th:text="${error}"></span>
</div>

<div>
    <div>
        <a href="/update/all">Update All</a>
    </div>
    <h2>File and Folder Structure</h2>

    <div id="folder-container">
    </div>
</div>

<script>

    function transcriptLinks (fileId, li) {
        const transcriptLink = document.createElement('a');
        transcriptLink.href = `/transcript/${fileId}`;
        transcriptLink.textContent = 'view';
        li.appendChild(document.createTextNode(' - '));
        li.appendChild(transcriptLink);

        const pdfLink = document.createElement('a');
        pdfLink.href = `/transcript/pdf/${fileId}`;
        pdfLink.textContent = 'pdf';
        li.appendChild(document.createTextNode(' - '));
        li.appendChild(pdfLink);

        const agentLink = document.createElement('a');
        agentLink.href = `/agent/${fileId}`;
        agentLink.textContent = 'agent';
        li.appendChild(document.createTextNode(' - '));
        li.appendChild(agentLink);

        const failedLink = document.createElement('a');
        failedLink.href = `/transcript/${fileId}/failed`;
        failedLink.textContent = 'view failed';
        li.appendChild(document.createTextNode(' - '));
        li.appendChild(failedLink);

        const forceUpdateLink = document.createElement('a');
        forceUpdateLink.href = `/transcript/force-update/${fileId}`;
        forceUpdateLink.textContent = 'force update';
        li.appendChild(document.createTextNode(' - '));
        li.appendChild(forceUpdateLink);

        const delLink = document.createElement('a');
        delLink.href = `/delete/${fileId}`;
        delLink.textContent = 'delete';
        li.appendChild(document.createTextNode(' - '));
        li.appendChild(delLink);
    }

    function formatDateTime(isoString) {
        const date = new Date(isoString);

        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    async function fetchAndRenderTree() {
        const response = await fetch('/transcript/recent');
        const fileNodes = await response.json();
        const container = document.getElementById('folder-container');
        container.appendChild(buildTree(fileNodes));
    }

    function buildTree(nodes) {
        const ul = document.createElement('ul');

        nodes.forEach(node => {
            const li = document.createElement('li');

            const parentNameSpan = document.createElement('span');
            parentNameSpan.textContent = node.parent.name;
            li.appendChild(parentNameSpan);

            const nameSpan = document.createElement('span');
            nameSpan.textContent = node.transcript.name;
            li.appendChild(document.createTextNode(' / '));
            li.appendChild(nameSpan);

            const dateSpan = document.createElement('span');

            const formatted = formatDateTime(node.transcript.transcripted_at);

            console.log(formatted);
            dateSpan.textContent = formatted;
            li.appendChild(document.createTextNode(' ('));
            li.appendChild(dateSpan);
            li.appendChild(document.createTextNode(')'));

            transcriptLinks(node.transcript.fileId, li);


            ul.appendChild(li);
        });
        return ul;
    }

    // async function fetchAndRenderTree() {
    //     const response = await fetch('/folder/list');
    //     const fileNodes = await response.json();
    //     const container = document.getElementById('folder-container');
    //     container.appendChild(buildTree(fileNodes));
    // }
    //
    // function buildTree(nodes) {
    //     const ul = document.createElement('ul');
    //
    //     nodes.forEach(node => {
    //         const li = document.createElement('li');
    //
    //         const nameSpan = document.createElement('span');
    //         nameSpan.textContent = node.name;
    //         li.appendChild(nameSpan);
    //
    //         if (node.folder) {
    //             const refreshLink = document.createElement('a');
    //             refreshLink.href = `/update/folder/${node.dtoFile.fileId}`;
    //             refreshLink.textContent = 'refresh';
    //             li.appendChild(document.createTextNode(' - '));
    //             li.appendChild(refreshLink);
    //
    //             const folderPdf = document.createElement('a');
    //             folderPdf.href = `/folder/pdf/${node.dtoFile.fileId}`;
    //             folderPdf.textContent = 'pdf';
    //             li.appendChild(document.createTextNode(' - '));
    //             li.appendChild(folderPdf);
    //
    //         } else {
    //             const pagesSpan = document.createElement('span');
    //             pagesSpan.textContent = `(${node.dtoTranscript.pageCount} pages)`;
    //             li.appendChild(document.createTextNode(' - '));
    //             li.appendChild(pagesSpan);
    //
    //             const transcriptLink = document.createElement('a');
    //             transcriptLink.href = `/transcript/${node.dtoFile.fileId}`;
    //             transcriptLink.textContent = 'view';
    //             li.appendChild(document.createTextNode(' - '));
    //             li.appendChild(transcriptLink);
    //
    //             const failedLink = document.createElement('a');
    //             failedLink.href = `/transcript/${node.dtoFile.fileId}/failed`;
    //             failedLink.textContent = 'view failed';
    //             li.appendChild(document.createTextNode(' - '));
    //             li.appendChild(failedLink);
    //
    //             const forceUpdateLink = document.createElement('a');
    //             forceUpdateLink.href = `/transcript/force-update/${node.dtoFile.fileId}`;
    //             forceUpdateLink.textContent = 'force update';
    //             li.appendChild(document.createTextNode(' - '));
    //             li.appendChild(forceUpdateLink);
    //
    //             const pdfLink = document.createElement('a');
    //             pdfLink.href = `/transcript/pdf/${node.dtoFile.fileId}`;
    //             pdfLink.textContent = 'pdf';
    //             li.appendChild(document.createTextNode(' - '));
    //             li.appendChild(pdfLink);
    //         }
    //
    //         const agentLink = document.createElement('a');
    //         agentLink.href = `/agent/${node.dtoFile.fileId}`;
    //         agentLink.textContent = 'agent';
    //         li.appendChild(document.createTextNode(' - '));
    //         li.appendChild(agentLink);
    //
    //         const delLink = document.createElement('a');
    //         delLink.href = `/delete/${node.dtoFile.fileId}`;
    //         delLink.textContent = 'delete';
    //         li.appendChild(document.createTextNode(' - '));
    //         li.appendChild(delLink);
    //
    //         if (node.folder && node.children && node.children.length > 0) {
    //             li.appendChild(buildTree(node.children));
    //         }
    //
    //         ul.appendChild(li);
    //     });
    //     return ul;
    // }

    document.addEventListener('DOMContentLoaded', fetchAndRenderTree);
</script>

</body>
</html>